<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEIO DIARY - ボクのバスケ日記</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'main-color': '#B0E0E6',       // 淡い青
              'accent-color': '#FF7F50',     // 情熱のアクセント (コーラル)
              'dark-color': '#1F3F5F',       // 濃い青
              'owner-pink': '#EC4899',       // オーナーモードのピンク
            },
            // hover:shadow-3xl が使われているためカスタムシャドウを定義
            boxShadow: {
              '3xl': '0 35px 60px -15px rgba(0, 0, 0, 0.3)',
            }
          }
        }
      }
    </script>

</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel"> 
        // 外部ファイルから読み込まれるはずのグローバル変数を定義
        // ★★★ 注：Firebaseを使用するには、ここに実際のFirebaseプロジェクト設定が必要です ★★★
        const __firebase_config = JSON.stringify({}); // 設定がない場合は空のJSON
        const __initial_auth_token = null; 
        const __app_id = 'seio-asuka-diary'; 

        // ----------------------------------------------------
        // --- [ 新規 テキスト ドキュメント.txt の内容をペースト ] ---
        // ----------------------------------------------------

        // から export default App; まで、すべてのコードをここに挿入

        // --- Firebase関連のインポート（モジュールではないため、ここではimport/exportを削除または調整） ---
        // Babelはimport/exportを変換するため、ここでは元の記述を残します。
        import React, { useState, useEffect, useMemo, useCallback } from 'react';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { 
          getFirestore, doc, onSnapshot, setDoc, setLogLevel
        } from 'firebase/firestore';
        // Tailwind CSS is assumed to be available.

        // --- [ 1. Firebase/Firestore の初期設定とインポート ] ---
        // Firestoreのログレベルを設定 (デバッグ用)
        setLogLevel('debug');
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ?
        __initial_auth_token : null; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let db, auth;
        let isMockMode = false; // ★★★ なびが追記した行

        // 設定がある場合のみFirebaseを初期化
        if (Object.keys(firebaseConfig).length > 0) {
          try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
          } catch (e) {
            console.error("🚨 Firebase Initialization Error:", e);
            isMockMode = true; // ★★★ なびが追記した行
          }
        } else {
            console.warn("⚠️ Firebase config not found. Running in mock data mode.");
            isMockMode = true; // ★★★ なびが追記した行
        }

        // --- [ 1.5. モックデータ定義（ローカル実行用） ] --- // ★★★ なびが追記したセクション
        const MOCK_DATA = {
            [formatDate(new Date())]: { // 今日
                title: "【モック】強豪校との練習試合！",
                content: "今日は Firebase に接続できなかったため、このモックデータが表示されています。ローカルでは保存はできませんが、UIの動作は確認できます！\n\nバスケの練習はデージちばったさーね！次の試合も勝つさー！",
                mood: "最高",
                updatedAt: new Date(),
                createdAt: new Date(),
            },
            "2025-10-17": { // 以前の会話で出た明日香ちゃんの設定日
                title: "【モック】ボクの一人称は「ボク」だよ。",
                content: "この日は、ボクの設定が完成した日だよ。ボクの一人称は「ボク」って、デージ重要なはずよ。",
                mood: "普通",
                updatedAt: new Date(),
                createdAt: new Date(),
            }
            // 他の日付のモックデータもここに追加できます
        };
        // --- [ 2. ユーティリティ関数と定数 ] ---
        // （ここは変更なし）
        // ...
        
        // --- [ 3. コンポーネント群 ] ---

        // （UserIdentificationは変更なし）
        // ...

        // --- [ 3.1 閲覧モードコンポーネント ] ---

        // （renderDiaryViewerは変更なし）
        // ...
        
        // --- [ 3.2 編集モードコンポーネント ] ---

        // （renderDiaryEditorは変更なし）
        // ...


        // 日記の表示とカレンダーUIを統合したメインセクション
        const DiaryCalendarSection = ({ userId, isOwner, isEditingMode, setIsEditingMode }) => {
          // ... State定義（変更なし）
          const today = useMemo(() => new Date(), []);
          const [selectedDate, setSelectedDate] = useState(today);
          const [currentDiary, setCurrentDiary] = useState(null);
          const [loading, setLoading] = useState(true);
          const [currentMonth, setCurrentMonth] = useState(today.getMonth());
          const [currentYear, setCurrentYear] = useState(today.getFullYear());
          
          // 編集フォーム用のState
          const [editorTitle, setEditorTitle] = useState('');
          const [editorContent, setEditorContent] = useState('');
          const [editorMood, setEditorMood] = useState('普通');
          const [isSaving, setIsSaving] = useState(false);
          const [saveMessage, setSaveMessage] = useState('');
          // 編集中のデータが未保存かどうかを判定するState (UX改善のため)
          const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false); 

          // --- [ A. Firestoreデータ取得ロジック（修正） ] ---
          useEffect(() => {
            // 認証待ち、またはDB未初期化の場合は早期リターン
            if (!db || !userId) {
                // ★★★ ここからローカル対応の修正 ★★★
                if (isMockMode) {
                    setLoading(false);
                    const docId = formatDate(selectedDate);
                    const data = MOCK_DATA[docId];
                    setCurrentDiary(data || null);
                    
                    if (isOwner) {
                        setEditorTitle(data?.title || '');
                        setEditorContent(data?.content || '');
                        setEditorMood(data?.mood || '普通');
                        setSaveMessage('⚠️ モックデータ表示中です。保存はできません。');
                        setIsEditingMode(false); // モックモードでは閲覧のみ
                    }
                    return;
                }
                // ★★★ ここまでローカル対応の修正 ★★★

                setLoading(false);
                if (isOwner) {
                    setSaveMessage('認証を待っています...');
                }
                return; 
            }

            setLoading(true);
            const docId = formatDate(selectedDate); 
            // 
            // プライベートデータパス: artifacts/{appId}/users/{userId}/diaries/{日付}
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/diaries`, docId);

            
            const unsubscribeSnapshot = onSnapshot(docRef, (docSnap) => {
              let data = null;
              if (docSnap.exists()) {
                data = docSnap.data();
              }
              setCurrentDiary(data ? { id: docSnap.id, ...data, date: docSnap.id } : null);

              // オーナーの場合、フォームにデータを流し込む（閲覧モードでも同期）
              if (isOwner) {
                setEditorTitle(data?.title || '');
          
                setEditorContent(data?.content || '');
                setEditorMood(data?.mood || '普通');
                setSaveMessage(data ? 'この日記を編集できます。' : '未記入です。新しい記事を作成できます！');
                setHasUnsavedChanges(false); // データ同期後は変更なしと見なす
              }

              setLoading(false);
            }, (error) => {
              console.error("Firestore Snapshot Error:", error);
              setLoading(false);
            });

            return () => unsubscribeSnapshot();
          }, [userId, selectedDate, isOwner]); 
          
          // 編集内容の変更を監視し、未保存フラグを更新
          // ... （このロジックは変更なし）
          useEffect(() => {
            // 現在のFirestoreデータとエディタの値を比較
            const currentTitle = currentDiary?.title || '';
            const currentContent = currentDiary?.content || '';
            const currentMood = currentDiary?.mood || '普通';

            const isDirty = (
                editorTitle !== currentTitle ||
                editorContent !== currentContent ||
                editorMood !== currentMood
            );
            
            // ロード中でない、かつオーナーの場合のみフラグを更新
            if (!loading && 
            isOwner) {
                setHasUnsavedChanges(isDirty);
            }
          }, [editorTitle, editorContent, editorMood, currentDiary, loading, isOwner]);
        // --- [ B. 日記保存ロジック (オーナー専用)（修正） ] ---
          const handleSave = async () => {
              // ★★★ ここからローカル対応の修正 ★★★
              if (isMockMode) {
                  setSaveMessage('🚨 モックモードでは保存できません。サーバーにアップロードするか、Firebaseを設定してください。');
                  return;
              }
              // ★★★ ここまでローカル対応の修正 ★★★
              
              if (!db || !auth || !userId) {
                  setSaveMessage('🚨 データベース接続エラー、または未認証です。');
                  return;
              }
              if (!editorTitle.trim() && !editorContent.trim()) {
                  setSaveMessage('🚨 タイトルか内容のどちらかを入力してください。');
                  return;
              }

              setIsSaving(true);
              setSaveMessage('✨ 保存中... サーバーへデータを送信しています。');

              const docId = formatDate(selectedDate);
              const docRef = doc(db, `artifacts/${appId}/users/${userId}/diaries`, docId);
              
              try {
                  // setDoc with merge: trueで、フィールドを上書きまたは新規作成
                  await setDoc(docRef, {
                      title: editorTitle,
                      content: editorContent,
                      mood: editorMood,
                      updatedAt: new Date(),
              
                      // 新規作成時のみcreatedAtを設定 (既存のcreatedAtはFirestoreのスナップショットから取得しているため、ここでは上書きしない)
                      createdAt: currentDiary?.createdAt || new Date(), 
                  }, { merge: true });
                  setSaveMessage('✅ ボクの日記の保存が完了しました！');
                  setHasUnsavedChanges(false); // 保存完了
                  // 保存成功後、自動的に閲覧モードに戻る
                  setIsEditingMode(false);
              } catch (error) {
                  console.error("Firestore Save Error:", error);
                  setSaveMessage(`🔥 保存失敗: エラーコード ${error.code}が発生しました。`);
              } finally {
                  setIsSaving(false);
              }
          };
        // 未保存の変更がある場合の確認ハンドラ
          // ... （このロジックは変更なし）
          const handleUnsavedChangeCheck = (callback) => {
              // オーナーかつ編集中で未保存の変更がある場合
              if (isOwner && isEditingMode && hasUnsavedChanges) {
                  // カスタムモーダルの代わりに、一時的なUIメッセージでユーザーに確認を促す
                  setSaveMessage('🚨 未保存の変更があります！中止ボタンで破棄するか、保存ボタンで保存してください。');
        // 変更をキャンセルしたことを伝えるため、falseを返す（カレンダー操作を中止）
                  return false;
              }
              // 変更がない、またはゲストの場合はそのまま実行
              callback();
        // 変更があった場合はすでにfalseが返っているので、成功時はtrueを返す（カレンダー操作を実行）
              return true;
          };
        // --- [ C. カレンダーUIロジック ] ---
          // ... (以降のロジックは変更なし)
          const getFirstDayOfMonth = (year, month) => new Date(year, month, 1);
          // ... （最後まで）
          
        // --- [ 4. メイン App コンポーネント ] ---

        const App = () => {
            // ... (Appコンポーネント内は変更なし)
            const [userId, setUserId] = useState(null);
            const [userName, setUserName] = useState(GUEST_NAME); 
            // 編集モードの状態をトップレベルで管理
            const [isEditingMode, setIsEditingMode] = useState(false);
            const isOwner = userName === OWNER_EMAIL;

            // Firebase認証処理
            const signIn = useCallback(async () => {
                if (!auth) return;
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Firebase: Signed in with Custom Token.");
                   
                    } else {
                        await signInAnonymously(auth);
                        console.log("Firebase: Signed in Anonymously.");
                    }
                } catch (error) {
                    console.error("🚨 Authentication failed during sign-in attempt:", error);
                }
            }, []);
        // 認証状態の監視と処理
            useEffect(() => {
                if (!auth) { // ★★★ モックモード対応：authオブジェクトがない場合は処理しない
                  if (isMockMode) {
                      setUserId('MOCK_USER_ID'); // ダミーのIDを設定
                      return;
                  }
                  return; 
                }

                const unsubscribeAuth = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // Auth IDを短縮せずに全て表示する
                        setUserId(user.uid); 
                        console.log("Firebase: Auth state 
                        changed. User ID set:", user.uid);
                    } else {
                        // ユーザーがいない場合はサインインを試みる
                        await signIn();
                    }
                });

                return () => unsubscribeAuth();
            }, [auth, signIn]);
        // モバイル用固定ボタンの表示/非表示フラグ
            const showFixedButton = isOwner; 
            
            return (
                <div className="min-h-screen antialiased text-gray-900 font-sans">
                    <Header 
                        userName={userName} 
                        setUserName={setUserName} 
                        userId={userId} 
                    />
          
                    {/* pt-16でヘッダー下のスペースを確保。モバイルの固定フッターのpb-20を適用/解除 */}
                    <main className={`pt-16 ${showFixedButton && 'pb-20 lg:pb-0'}`}> 
                        <HeroSection />
                        <DiaryCalendarSection 
                            userId={userId} 
                       
                            isOwner={isOwner} 
                            isEditingMode={isEditingMode} 
                            setIsEditingMode={setIsEditingMode} 
                        />
                    </main>
                    <Footer />
                </div>
           
              );
            };

        // ----------------------------------------------------
        // --- [ 6. アプリの描画 ] ---
        // ----------------------------------------------------
        
        // AppコンポーネントをDOMにレンダリングする
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
        
    </script>
</body>
</html>