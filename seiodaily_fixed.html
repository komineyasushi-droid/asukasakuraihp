<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEIO DIARY (明日香の日記)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
    
    <script type="text/babel">
        // ----------------------------------------------------------------------
        // ★ カラー定義とTailwind設定の統合
        // ----------------------------------------------------------------------
        const COLORS = {
            MAIN: '#FDFCFB',    // メイン背景
            ACCENT: '#FF7F50',  // アクセントカラー（集中線など）
            DARK: '#00AEEF',    // テキストやアイコン（青）
            OWNER: '#FEE2E2',   // オーナーモードの背景色 (薄い赤)
            TODAY: '#93C5FD',   // 今日の日付の背景色 (青)
        };

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'c-main': COLORS.MAIN,
                        'c-accent': COLORS.ACCENT,
                        'c-dark': COLORS.DARK,
                        'c-owner': COLORS.OWNER,
                        'c-today': COLORS.TODAY,
                    },
                }
            }
        };
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        // --------------------------------------------------------------------------------------
        // 🚨 ユーザー様へ：ここを実際の値に置き換えてください（最重要）
        // --------------------------------------------------------------------------------------
        const FIREBASE_CONFIG = {
            apiKey: "YOUR_API_KEY_HERE",           // 例: "AIzaSyCxXXXXXXXXXXXXXXXXXXXXX"
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",          // 例: "seio-diary-12345"
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        const APP_ID = FIREBASE_CONFIG.appId;
        const OWNER_EMAIL_ADDRESS = "owner@example.com"; // 🚨 ここにオーナーとしてログインしたいメールアドレスを設定
        // --------------------------------------------------------------------------------------
        
        const hasFirebase = FIREBASE_CONFIG.apiKey !== "YOUR_API_KEY_HERE";

        // Firebase初期化（設定がプレースホルダーでない場合のみ）
        let appInstance = null;
        let dbInstance = null;
        let authInstance = null;

        if (hasFirebase) {
            try {
                appInstance = firebase.initializeApp(FIREBASE_CONFIG);
                dbInstance = firebase.firestore();
                authInstance = firebase.auth();
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
            }
        }
        
        // ローカルストレージキー
        const LS_KEY_USER = 'seio_diary_user_name';
        const LS_KEY_DATE = 'seio_diary_current_date';

        // ----------------------------------------------------------------------
        // ★ 共通ユーティリティ
        // ----------------------------------------------------------------------
        const DateUtils = {
            formatDateKey: (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}${month}${day}`;
            },
            formatDisplayDate: (date) => {
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];
                return `${year}年${month}月${day}日 (${dayOfWeek})`;
            },
            getDaysInMonth: (year, month) => new Date(year, month + 1, 0).getDate(),
            getStartDayOfWeek: (year, month) => new Date(year, month, 1).getDay(),
            isSameDay: (date1, date2) => (
                date1.getFullYear() === date2.getFullYear() &&
                date1.getMonth() === date2.getMonth() &&
                date1.getDate() === date2.getDate()
            ),
            getMonthAndYear: (date) => ({
                year: date.getFullYear(),
                month: date.getMonth(),
            }),
            createDateFromKey: (key) => {
                const year = parseInt(key.substring(0, 4), 10);
                const month = parseInt(key.substring(4, 6), 10) - 1;
                const day = parseInt(key.substring(6, 8), 10);
                return new Date(year, month, day);
            }
        };

        // ----------------------------------------------------------------------
        // ★ コンポーネント定義
        // ----------------------------------------------------------------------

        // === Header コンポーネント ===
        const Header = ({ userName, setUserName, userId }) => {
            const [inputName, setInputName] = useState(userName || '');
            const [isOwner, setIsOwner] = useState(userName === OWNER_EMAIL_ADDRESS);

            const handleLogin = (e) => {
                e.preventDefault();
                const newUserName = inputName.trim();
                setUserName(newUserName);
                localStorage.setItem(LS_KEY_USER, newUserName);
                setIsOwner(newUserName === OWNER_EMAIL_ADDRESS);
            };

            const handleLogout = () => {
                setUserName('');
                localStorage.removeItem(LS_KEY_USER);
                setIsOwner(false);
                setInputName('');
                if (authInstance) {
                    authInstance.signOut();
                }
            };

            return (
                <header className={`fixed top-0 left-0 w-full p-4 shadow-md z-10 transition-colors duration-300 ${isOwner ? 'bg-c-owner text-c-dark' : 'bg-white text-gray-800'}`}>
                    <div className="max-w-4xl mx-auto flex justify-between items-center">
                        <h1 className={`text-2xl font-bold transition-colors duration-300 ${isOwner ? 'text-c-dark' : 'text-c-accent'}`}>
                            SEIO DIARY
                        </h1>

                        <div className="flex items-center space-x-4">
                            {userName ? (
                                <div className="flex items-center space-x-2">
                                    <span className="text-sm font-medium">
                                        {isOwner ? `オーナー様 (ID: ${userId})` : `ゲスト: ${userName}`}
                                    </span>
                                    <button
                                        onClick={handleLogout}
                                        className={`px-3 py-1 text-sm font-semibold rounded-full transition-colors duration-300 ${isOwner ? 'bg-white text-c-dark hover:bg-gray-100' : 'bg-c-dark text-white hover:bg-c-accent'}`}
                                    >
                                        ログアウト
                                    </button>
                                </div>
                            ) : (
                                <form onSubmit={handleLogin} className="flex space-x-2">
                                    <input
                                        type="email"
                                        value={inputName}
                                        onChange={(e) => setInputName(e.target.value)}
                                        placeholder="メールアドレスを入力"
                                        className="p-2 border border-gray-300 rounded-lg text-sm w-48 text-gray-700 focus:ring-2 focus:ring-c-accent focus:border-c-accent"
                                        required
                                    />
                                    <button
                                        type="submit"
                                        className="px-3 py-1 bg-c-accent text-white font-semibold rounded-lg hover:bg-opacity-90 transition-opacity text-sm"
                                    >
                                        ログイン
                                    </button>
                                </form>
                            )}
                        </div>
                    </div>
                </header>
            );
        };

        // === DiaryEditor コンポーネント ===
        const DiaryEditor = ({ userId, dbInstance, selectedDate, diaryContent, setDiaryContent, isEditingMode, setIsEditingMode, hasFirebase }) => {
            const [isSaving, setIsSaving] = useState(false);
            const [saveMessage, setSaveMessage] = useState('');
            const [initialContent, setInitialContent] = useState(diaryContent);

            useEffect(() => {
                setInitialContent(diaryContent);
            }, [diaryContent]);

            // 未保存の変更があるかをチェック
            const hasUnsavedChanges = diaryContent !== initialContent;

            // 日記のパスを計算
            const dateKey = DateUtils.formatDateKey(selectedDate);
            const diaryRef = dbInstance ? dbInstance.collection('artifacts').doc(APP_ID).collection('users').doc(userId).collection('diaries').doc(dateKey) : null;

            const handleSave = async () => {
                if (!hasFirebase || !dbInstance) {
                    setSaveMessage('🚨 Firebaseが設定されていません。保存できません。');
                    return;
                }
                if (isSaving || !diaryRef) return;
                
                if (diaryContent.trim() === '') {
                    // 空白の場合は削除として扱う
                    await handleDelete();
                    return;
                }

                setIsSaving(true);
                setSaveMessage('保存中...');

                try {
                    await diaryRef.set({
                        date: dateKey,
                        content: diaryContent,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    });
                    setInitialContent(diaryContent); // 初期値を更新
                    setSaveMessage('✨ 保存完了しました！');
                    setIsEditingMode(false);
                } catch (error) {
                    console.error("Firestore Save Error:", error);
                    setSaveMessage('🔥 保存に失敗しました: ' + error.message);
                } finally {
                    setIsSaving(false);
                }

                // 3秒後にメッセージを消去
                setTimeout(() => setSaveMessage(''), 3000);
            };

            const handleDelete = async () => {
                if (!hasFirebase || !dbInstance || !diaryRef) return;

                const confirmed = window.confirm('本当にこの日の日記を削除しますか？');
                if (!confirmed) return;

                try {
                    await diaryRef.delete();
                    setDiaryContent('');
                    setInitialContent('');
                    setSaveMessage('🗑️ 日記を削除しました。');
                    setIsEditingMode(false);
                } catch (error) {
                    console.error("Firestore Delete Error:", error);
                    setSaveMessage('🔥 削除に失敗しました: ' + error.message);
                }

                // 3秒後にメッセージを消去
                setTimeout(() => setSaveMessage(''), 3000);
            };

            const handleCancel = () => {
                if (hasUnsavedChanges) {
                    const confirmed = window.confirm('未保存の変更があります。編集を中止すると内容は破棄されますがよろしいですか？');
                    if (!confirmed) return;
                }
                setDiaryContent(initialContent); // 元の内容に戻す
                setIsEditingMode(false);
                setSaveMessage('');
            };

            return (
                <div className="bg-white p-6 rounded-xl shadow-lg border-2 border-c-dark">
                    <div className="flex justify-between items-start mb-4">
                        <h2 className={`text-xl font-bold text-c-dark`}>
                            {DateUtils.formatDisplayDate(selectedDate)} の日記
                        </h2>
                        {isEditingMode && (
                            <div className="flex space-x-2">
                                <button
                                    onClick={handleSave}
                                    disabled={isSaving || !hasUnsavedChanges}
                                    className="px-4 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 disabled:opacity-50 transition-colors"
                                >
                                    {isSaving ? '保存中' : '💾 保存'}
                                </button>
                                <button
                                    onClick={handleCancel}
                                    className="px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition-colors"
                                >
                                    中止
                                </button>
                                <button
                                    onClick={handleDelete}
                                    className="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition-colors"
                                >
                                    削除
                                </button>
                            </div>
                        )}
                        {!isEditingMode && (
                            <button
                                onClick={() => setIsEditingMode(true)}
                                className="px-4 py-2 bg-c-accent text-white font-semibold rounded-lg hover:bg-opacity-90 transition-opacity"
                            >
                                ✏️ 編集開始
                            </button>
                        )}
                    </div>

                    {saveMessage && (
                        <p className={`mb-4 p-2 rounded-lg text-sm font-medium ${saveMessage.startsWith('✨') ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                            {saveMessage}
                        </p>
                    )}

                    {isEditingMode ? (
                        <textarea
                            value={diaryContent}
                            onChange={(e) => {
                                setDiaryContent(e.target.value);
                                setSaveMessage(''); // 編集開始でメッセージクリア
                            }}
                            className="w-full min-h-[300px] p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-c-accent focus:border-c-accent text-gray-800 resize-none"
                            placeholder="今日あったこと、考えたことをここに書いてね..."
                        />
                    ) : (
                        <div className="prose max-w-none min-h-[300px] p-4 border border-gray-200 rounded-lg bg-gray-50 whitespace-pre-wrap text-gray-700">
                            {diaryContent ? diaryContent : (
                                <p className="text-gray-400 italic">この日はまだ日記が書かれていません。</p>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // === DiaryCalendarSection コンポーネント ===
        const DiaryCalendarSection = ({ userId, isOwner, isEditingMode, setIsEditingMode, dbInstance, hasFirebase }) => {
            const initialDateKey = localStorage.getItem(LS_KEY_DATE) || DateUtils.formatDateKey(new Date());
            const [selectedDate, setSelectedDate] = useState(DateUtils.createDateFromKey(initialDateKey));
            const [currentMonthYear, setCurrentMonthYear] = useState(DateUtils.getMonthAndYear(selectedDate));
            const [diaryContent, setDiaryContent] = useState('');
            const [dataLoaded, setDataLoaded] = useState(false);
            const [saveMessage, setSaveMessage] = useState('');

            // 未保存の変更があるかをチェック (DiaryEditorとロジックを共有)
            const [initialContent, setInitialContent] = useState('');
            const hasUnsavedChanges = diaryContent !== initialContent;

            // Firestoreから日記データを購読
            useEffect(() => {
                if (!hasFirebase || !dbInstance) {
                    setDiaryContent('');
                    setInitialContent('');
                    setDataLoaded(true);
                    return;
                }

                // 選択された日付の参照を作成
                const dateKey = DateUtils.formatDateKey(selectedDate);
                const diaryRef = dbInstance.collection('artifacts').doc(APP_ID).collection('users').doc(userId).collection('diaries').doc(dateKey);
                
                setDataLoaded(false);

                // リアルタイムリスナーを設定
                const unsubscribe = diaryRef.onSnapshot(doc => {
                    const data = doc.data();
                    const content = data ? (data.content || '') : '';
                    
                    // 編集モードでない場合のみ内容を更新（編集中は手動更新）
                    // 購読開始時、または外部から変更があった場合は常に更新
                    if (!isEditingMode) {
                        setDiaryContent(content);
                        setInitialContent(content);
                    }
                    setDataLoaded(true);
                }, error => {
                    console.error("Firestore Listen Error:", error);
                    setDiaryContent(`🚨 データ取得エラー: ${error.message}`);
                    setInitialContent(`🚨 データ取得エラー: ${error.message}`);
                    setDataLoaded(true);
                });

                // クリーンアップ関数
                return () => {
                    unsubscribe();
                };
            }, [selectedDate, userId, isEditingMode, hasFirebase, dbInstance]);

            // 日付クリックハンドラ
            const handleDateClick = (date) => {
                // ★ 修正点2: 未保存変更チェックをwindow.confirmに変更
                if (isOwner && isEditingMode && hasUnsavedChanges) {
                    const confirmed = window.confirm('🚨 未保存の変更があります。日付を移動すると、現在の編集内容は破棄されますがよろしいですか？');
                    if (!confirmed) {
                        // ユーザーがキャンセルした場合、操作を中断
                        return;
                    }
                    // ユーザーがOKした場合、編集モードを解除して続行（破棄）
                    setIsEditingMode(false);
                    setSaveMessage('');
                    // setHasUnsavedChanges(false); // 次のuseEffectでinitialContentが更新されるため不要
                }
                
                // 日付を更新
                setSelectedDate(date);
                setCurrentMonthYear(DateUtils.getMonthAndYear(date));
                localStorage.setItem(LS_KEY_DATE, DateUtils.formatDateKey(date));
            };

            // カレンダー移動ハンドラ
            const handleMonthChange = (offset) => {
                if (isOwner && isEditingMode && hasUnsavedChanges) {
                    // 編集モード中の移動は許可しない（先にconfirmで破棄させる）
                    window.alert('🚨 編集中です。先に保存または中止ボタンで破棄してください。');
                    return;
                }

                const newMonth = currentMonthYear.month + offset;
                const newDate = new Date(currentMonthYear.year, newMonth, 1);
                setCurrentMonthYear(DateUtils.getMonthAndYear(newDate));
                
                // 月移動しても選択日付は1日にリセットしない
                // 選択日付がその月に存在しない場合は月末にするロジックは今回はスキップ
            };

            const handleYearChange = (e) => {
                const newYear = parseInt(e.target.value, 10);
                const newDate = new Date(newYear, currentMonthYear.month, 1);
                setCurrentMonthYear(DateUtils.getMonthAndYear(newDate));
            };

            // カレンダーデータ生成
            const generateCalendar = useMemo(() => {
                const { year, month } = currentMonthYear;
                const daysInMonth = DateUtils.getDaysInMonth(year, month);
                const startDayOfWeek = DateUtils.getStartDayOfWeek(year, month);
                const calendar = [];

                // 前月の日付（グレイアウト部分）
                const prevMonthDays = DateUtils.getDaysInMonth(year, month - 1);
                for (let i = startDayOfWeek - 1; i >= 0; i--) {
                    calendar.push({
                        day: prevMonthDays - i,
                        isCurrentMonth: false,
                        date: new Date(year, month - 1, prevMonthDays - i)
                    });
                }

                // 今月の日付
                for (let i = 1; i <= daysInMonth; i++) {
                    calendar.push({
                        day: i,
                        isCurrentMonth: true,
                        date: new Date(year, month, i)
                    });
                }
                
                // 次月の日付（グレイアウト部分）
                const totalCells = calendar.length;
                const remainingCells = 42 - totalCells; // 6週間表示を想定
                
                for (let i = 1; i <= remainingCells; i++) {
                     calendar.push({
                        day: i,
                        isCurrentMonth: false,
                        date: new Date(year, month + 1, i)
                    });
                }

                return calendar.slice(0, 42); // 最大6週間分
            }, [currentMonthYear]);

            // 年選択肢の生成
            const yearOptions = useMemo(() => {
                const currentYear = new Date().getFullYear();
                const years = [];
                for (let i = currentYear - 5; i <= currentYear + 5; i++) {
                    years.push(i);
                }
                return years;
            }, []);


            return (
                <div className={`max-w-4xl mx-auto pt-6 px-4 pb-12 ${isOwner ? 'bg-c-owner/50' : ''}`}>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        {/* カレンダーセクション (左側) */}
                        <div className="lg:col-span-1 bg-white p-4 rounded-xl shadow-lg h-fit border-2 border-c-dark">
                            {/* カレンダーヘッダー */}
                            <div className="flex justify-between items-center mb-4">
                                <button onClick={() => handleMonthChange(-1)} className="p-2 hover:bg-gray-100 rounded-full text-c-dark">
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7"></path></svg>
                                </button>
                                <div className="flex items-center space-x-2">
                                    <select
                                        value={currentMonthYear.year}
                                        onChange={handleYearChange}
                                        className="p-1 border border-gray-300 rounded-lg text-sm bg-white"
                                    >
                                        {yearOptions.map(y => <option key={y} value={y}>{y}年</option>)}
                                    </select>
                                    <h3 className="text-xl font-semibold text-gray-800">
                                        {currentMonthYear.month + 1}月
                                    </h3>
                                </div>
                                <button onClick={() => handleMonthChange(1)} className="p-2 hover:bg-gray-100 rounded-full text-c-dark">
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7"></path></svg>
                                </button>
                            </div>

                            {/* 曜日ヘッダー */}
                            <div className="grid grid-cols-7 text-center text-sm font-medium text-gray-500 mb-2">
                                {['日', '月', '火', '水', '木', '金', '土'].map(day => (
                                    <div key={day} className={day === '日' ? 'text-red-500' : day === '土' ? 'text-blue-500' : ''}>{day}</div>
                                ))}
                            </div>

                            {/* 日付グリッド */}
                            <div className="grid grid-cols-7 gap-1">
                                {generateCalendar.map((item, index) => {
                                    const isToday = DateUtils.isSameDay(item.date, new Date());
                                    const isSelected = DateUtils.isSameDay(item.date, selectedDate);
                                    
                                    const baseClasses = `p-1 h-10 w-10 flex items-center justify-center rounded-full text-sm transition-all duration-150 cursor-pointer hover:bg-gray-100`;
                                    
                                    let cellClasses = baseClasses;

                                    if (item.isCurrentMonth) {
                                        cellClasses += ' text-gray-700';
                                    } else {
                                        cellClasses += ' text-gray-400';
                                    }

                                    if (isToday) {
                                        // ★ 修正点3: Tailwindカスタムカラークラスを使用
                                        cellClasses += ` bg-c-today/50 font-bold border-2 border-c-today`;
                                    }

                                    if (isSelected) {
                                        // ★ 修正点3: Tailwindカスタムカラークラスを使用
                                        cellClasses += ` !bg-c-accent text-white shadow-md font-bold hover:!bg-c-accent/90`;
                                    }

                                    // 日曜・土曜の色付け
                                    const dayOfWeek = item.date.getDay();
                                    if (!isSelected && item.isCurrentMonth) {
                                        if (dayOfWeek === 0) cellClasses += ' text-red-500'; // 日曜日
                                        if (dayOfWeek === 6) cellClasses += ' text-blue-500'; // 土曜日
                                    }

                                    return (
                                        <div 
                                            key={index}
                                            className="flex justify-center items-center"
                                        >
                                            <div
                                                className={cellClasses}
                                                onClick={() => handleDateClick(item.date)}
                                            >
                                                {item.day}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        {/* 日記エディタセクション (右側) */}
                        <div className="lg:col-span-2">
                            {/* ローディングまたはFirebase未設定の表示 */}
                            {(!hasFirebase && userId) ? (
                                <div className="flex flex-col items-center justify-center h-full min-h-[400px] bg-white rounded-xl shadow-lg p-6 border-2 border-red-400">
                                    <div className="text-6xl mb-4" style={{ color: COLORS.ACCENT }}>🚨</div>
                                    <p className="mt-4 text-xl font-semibold text-red-700">
                                        Firebase設定が必要です
                                    </p>
                                    <p className="mt-2 text-gray-600 text-center">
                                        HTMLファイル内の `FIREBASE_CONFIG` を実際のプロジェクトキーに置き換えてください。
                                    </p>
                                </div>
                            ) : (!dataLoaded) ? (
                                <div className="flex flex-col items-center justify-center h-full min-h-[400px] bg-white rounded-xl shadow-lg p-6 border-2 border-c-dark animate-pulse">
                                    <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-c-accent"></div>
                                    <p className="mt-4 text-lg font-semibold" style={{ color: COLORS.DARK }}>
                                        システム初期設定中...
                                    </p>
                                </div>
                            ) : (
                                // 編集・閲覧コンポーネント
                                <DiaryEditor
                                    userId={userId}
                                    dbInstance={dbInstance}
                                    selectedDate={selectedDate}
                                    diaryContent={diaryContent}
                                    setDiaryContent={setDiaryContent}
                                    isEditingMode={isOwner && isEditingMode} // オーナーかつ編集モードの場合のみ編集を許可
                                    setIsEditingMode={setIsEditingMode}
                                    hasFirebase={hasFirebase}
                                />
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // === App コンポーネント (ルート) ===
        const App = () => {
            const [userName, setUserName] = useState(localStorage.getItem(LS_KEY_USER) || '');
            const [userId, setUserId] = useState(null);
            const [isOwner, setIsOwner] = useState(userName === OWNER_EMAIL_ADDRESS);
            const [isEditingMode, setIsEditingMode] = useState(false);
            const [isLoadingAuth, setIsLoadingAuth] = useState(true);

            useEffect(() => {
                setIsOwner(userName === OWNER_EMAIL_ADDRESS);
            }, [userName]);

            // Firebase 匿名認証処理
            useEffect(() => {
                if (!hasFirebase || !authInstance) {
                    setUserId(userName || 'guest_mode');
                    setIsLoadingAuth(false);
                    return;
                }

                const signInAnonymously = async () => {
                    try {
                        const userCredential = await authInstance.signInAnonymously();
                        setUserId(userCredential.user.uid);
                        console.log("Anonymous sign-in successful. UID:", userCredential.user.uid);
                    } catch (error) {
                        console.error("Anonymous sign-in failed:", error);
                        // 失敗した場合も最低限のゲストIDで続行
                        setUserId(userName || 'anonymous_error');
                    } finally {
                        setIsLoadingAuth(false);
                    }
                };
                
                // 認証状態の監視 (再読み込み時など)
                const unsubscribe = authInstance.onAuthStateChanged(user => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        signInAnonymously();
                    }
                });

                return () => unsubscribe();

            }, [hasFirebase]);


            if (isLoadingAuth) {
                return (
                    <div className="font-sans min-h-screen flex flex-col pt-16" style={{ backgroundColor: COLORS.MAIN }}>
                        <div className="flex flex-col items-center justify-center h-full min-h-[calc(100vh-64px)]">
                            <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-c-accent"></div>
                            <p className="mt-4 text-lg font-semibold" style={{ color: COLORS.DARK }}>
                                システム初期設定中...
                            </p>
                        </div>
                    </div>
                );
            }

            return (
                <div className={`font-sans min-h-screen flex flex-col pt-16`} style={{ backgroundColor: COLORS.MAIN }}>
                    <Header userName={userName} setUserName={setUserName} userId={userId} />
                    <main className="flex-grow">
                        <DiaryCalendarSection
                            userId={userId}
                            isOwner={isOwner}
                            isEditingMode={isEditingMode}
                            setIsEditingMode={setIsEditingMode}
                            dbInstance={dbInstance} // Firestoreインスタンスを渡す
                            hasFirebase={hasFirebase} // Firebaseが設定されているか
                        />
                    </main>
                    <footer className="w-full p-4 text-center text-sm text-gray-500 border-t">
                        <p>&copy; 2024 SEIO DIARY powered by React + Firebase. **(明香はボクっ娘です)**</p>
                    </footer>
                </div>
            );
        };

        // React アプリケーションのレンダリング
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>