<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arisa AI Studio | DALL-E 3 JSONãƒ“ãƒ«ãƒ€ãƒ¼ (ãªã³ã¡ã‚ƒã‚“QAä¿®æ­£ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght+400;700&display=swap');
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: #f7f9fc;
            min-height: 100vh;
        }
        .container-main {
            max-width: 1400px;
        }
        .input-card, .output-card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }
        .input-card:hover {
            transform: translateY(-2px);
        }
        .button-primary {
            background-color: #4f46e5; /* Indigo */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
        }
        .button-primary:hover {
            background-color: #4338ca;
            transform: translateY(-1px);
        }
        .button-primary:disabled {
            background-color: #a5b4fc;
            cursor: not-allowed;
        }
        .button-secondary {
            background-color: #e0e7ff; /* Indigo-200 */
            color: #4f46e5;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .button-secondary:hover {
            background-color: #c7d2fe; /* Indigo-300 */
        }
        .file-input-label {
            display: block;
            background-color: #eef2ff; /* Indigo-100 */
            color: #4f46e5;
            border: 2px dashed #a5b4fc; /* Indigo-300 */
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .file-input-label:hover {
            background-color: #e0e7ff; /* Indigo-200 */
        }
        /* ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã®ç”»åƒè¡¨ç¤ºç”¨ */
        .main-image-preview {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ã¤ã¤å…¨ä½“ã‚’è¡¨ç¤º */
            margin: auto; /* ä¸­å¤®å¯„ã› */
        }
        /* ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« (Tailwindã§ã‚«ãƒãƒ¼ã§ããªã„éƒ¨åˆ†) */
        @media (max-width: 1023px) {
            .mobile-menu-items {
                display: none; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§éè¡¨ç¤º */
                flex-direction: column;
                background-color: white;
                padding: 1rem;
                border-radius: 0.5rem;
                margin-top: 1rem;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            }
            .mobile-menu-items.open {
                display: flex; /* ã‚¯ãƒªãƒƒã‚¯ã§è¡¨ç¤º */
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="container-main mx-auto">
        <header class="mb-8 p-4 bg-white rounded-lg shadow-md flex justify-between items-center lg:block">
            <h1 class="text-2xl lg:text-4xl font-bold text-indigo-700">ğŸ‘©â€ğŸ’» ä¸Šé‡Œãªã³ QA Studio (ãƒã‚°ä¿®æ­£ Ver. 2.1)</h1>
            <button id="hamburgerButton" class="lg:hidden p-2 rounded-md text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            <p class="hidden lg:block text-gray-600 mt-2">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«åŸºã¥ã„ãŸ**JSONãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**ã‚’ç”Ÿæˆï¼†ã‚µãƒ¼ãƒãƒ¼é€ä¿¡ã—ã¾ã™ã€‚</p>
        </header>
        
        <div id="mobileMenu" class="mobile-menu-items lg:hidden">
            <p class="text-gray-600 mt-2">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«åŸºã¥ã„ãŸ**JSONãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**ã‚’ç”Ÿæˆï¼†ã‚µãƒ¼ãƒãƒ¼é€ä¿¡ã—ã¾ã™ã€‚</p>
        </div>


        <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-8 rounded-lg shadow-md" role="alert">
            <p class="font-bold">âš ï¸ QAãƒã‚§ãƒƒã‚¯æ¸ˆã¿ï¼</p>
            <p class="text-sm">æ·»ä»˜ç”»åƒã‚µã‚¤ã‚ºã¯**4MBä»¥ä¸‹æ¨å¥¨**ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã€‚ä¹±æ•°ã‚·ãƒ¼ãƒ‰ã¯$2^{64}-1$ã®ç©¶æ¥µã®å¢ƒç•Œå€¤ã§å›ºå®šã§ã™ã€‚</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 space-y-8">
                <div class="input-card p-6">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">1. ã‚¢ãƒ¼ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆå…¥åŠ›</h2>
                    
                    <label for="promptLanguage" class="block text-sm font-medium text-gray-700 mb-2">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¨€èª</label>
                    <select id="promptLanguage" class="w-full p-2 border border-gray-300 rounded-lg mb-4">
                        <option value="ja">æ—¥æœ¬èªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</option>
                        <option value="en">è‹±èªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</option>
                    </select>

                    <label for="userPrompt" class="block text-sm font-medium text-gray-700 mb-2">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ (æããŸã„å†…å®¹ / ç®‡æ¡æ›¸ãå¯)</label>
                    <textarea id="userPrompt" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-inner resize-none" placeholder="ä¾‹: æ˜æ—¥é¦™ãŒè±ªå¿«ã«ãƒ€ãƒ³ã‚¯ã‚·ãƒ¥ãƒ¼ãƒˆã‚’æ±ºã‚ã¦ã„ã‚‹æ§˜å­ã€ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«"></textarea>

                    
                    <div class="mt-4 flex items-center justify-between">
                        <button id="generateBtn" onclick="generateJsonAndDownload()" class="button-primary w-full">
                            JSONãƒªã‚¯ã‚¨ã‚¹ãƒˆç”Ÿæˆï¼†ã‚µãƒ¼ãƒãƒ¼é€ä¿¡
                        </button>
                    </div>
                </div>

                <div class="input-card p-6">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">1.5. æ·»ä»˜ç”»åƒ (æœ€å¤§2æš)</h2>
                    <p class="text-xs text-gray-500 mb-3">ç”»åƒã‚’é¸æŠã—ã€**å‚ç…§ç”»åƒã¨ã—ã¦ä½¿ç”¨ã™ã‚‹æ–¹ã‚’ãƒã‚§ãƒƒã‚¯**ã—ã¦ãã ã•ã„ã€‚</p>

                    <div class="space-y-6">
                        <div class="border p-3 rounded-lg bg-gray-50">
                            <label for="imageUpload1" class="file-input-label">ç”»åƒ 1 ã‚’é¸æŠ (.png/.jpg)</label>
                            <input type="file" id="imageUpload1" class="hidden" accept="image/png, image/jpeg" onchange="handleImageUpload(this, 'preview1_thumb', 'status1', 'mainPreviewImage', 'downloadImageBtn')">
                            <p id="status1" class="text-xs mt-1 text-gray-600 truncate">æœªé¸æŠ</p>
                            <img id="preview1_thumb" class="mt-2 h-16 w-16 object-cover rounded hidden" src="" alt="Image 1 Thumbnail">

                            <div class="mt-3">
                                <input type="radio" id="refImage1" name="reference_image" value="Image_1" onclick="updateReferenceStatus('Image_1')" checked>
                                <label for="refImage1" class="text-sm font-semibold text-indigo-700">ã“ã‚Œã‚’å‚ç…§ç”»åƒã¨ã—ã¦ä½¿ç”¨</label>
                            </div>
                        </div>
                        
                        <div class="border p-3 rounded-lg bg-gray-50">
                            <label for="imageUpload2" class="file-input-label">ç”»åƒ 2 ã‚’é¸æŠ (.png/.jpg)</label>
                            <input type="file" id="imageUpload2" class="hidden" accept="image/png, image/jpeg" onchange="handleImageUpload(this, 'preview2_thumb', 'status2', 'mainPreviewImage', 'downloadImageBtn')">
                            <p id="status2" class="text-xs mt-1 text-gray-600 truncate">æœªé¸æŠ</p>
                            <img id="preview2_thumb" class="mt-2 h-16 w-16 object-cover rounded hidden" src="" alt="Image 2 Thumbnail">
                            
                            <div class="mt-3">
                                <input type="radio" id="refImage2" name="reference_image" value="Image_2" onclick="updateReferenceStatus('Image_2')" disabled>
                                <label for="refImage2" class="text-sm font-semibold text-gray-500">ã“ã‚Œã‚’å‚ç…§ç”»åƒã¨ã—ã¦ä½¿ç”¨</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="output-card p-6">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">2. ç”ŸæˆJSONãƒªã‚¯ã‚¨ã‚¹ãƒˆ (ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿)</h2>
                    <pre id="output" class="bg-gray-50 p-3 rounded-lg text-sm overflow-x-auto h-64 border border-gray-200">
{
  "request_time": "...",
  "user_prompt": "ã“ã“ã«ç”Ÿæˆã•ã‚ŒãŸJSONãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚",
  "...": "..."
}</pre>
                    <p class="text-xs text-gray-500 mt-2">ã“ã®JSONãƒ‡ãƒ¼ã‚¿ã¯ã€ç”»åƒç”ŸæˆAPIã«é€ã‚‹ãŸã‚ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã§ã™ã€‚</p>
                    <div id="serverStatus" class="mt-4 p-2 bg-gray-100 rounded text-sm font-semibold text-gray-700">
                        ã‚µãƒ¼ãƒãƒ¼é€ä¿¡çŠ¶æ³: å¾…æ©Ÿä¸­...
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="output-card p-6 h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-800">3. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ (å…ƒçµµè¡¨ç¤º)</h2>
                        <button id="downloadImageBtn" onclick="downloadImage()" class="button-primary" disabled>
                            â¬‡ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (.png)
                        </button>
                    </div>
                    
                    <div class="flex-grow flex items-center justify-center bg-gray-100 rounded-lg relative overflow-hidden h-96 md:h-full min-h-[300px]">
                        
                        <div id="previewPlaceholder" class="p-8 text-center text-gray-500 transition-opacity duration-300">
                            <svg class="w-16 h-16 mx-auto mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            <p class="font-bold text-gray-700">é¸æŠã•ã‚ŒãŸç”»åƒãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                            <p>ã€Œæ·»ä»˜ç”»åƒã€ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã™ã‚‹ã¨ã€ãã®å…ƒçµµãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                        </div>
                        
                        <img id="mainPreviewImage" class="main-image-preview hidden" src="" alt="Main Image Preview" onerror="this.onerror=null; this.src='https://placehold.co/1024x1024/cbd5e1/4b5563?text=Image+Load+Failed'; this.classList.remove('hidden');" />
                    </div>
                    </div>
            </div>
        </div>
    </div>
    
    <script>
        // Arisa Studio Global Variables
        let globalSourceImage1Base64 = null;
        let globalSourceImage2Base64 = null;
        let globalSourceImage1Name = 'N/A';
        let globalSourceImage2Name = 'N/A';
        let globalCurrentBase64Image = null; 
        let globalReferenceImageId = 'Image_1'; 
        // ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ (ä»®ã®FC2 APIã‚’æƒ³å®š)
        const FC2_API_ENDPOINT = "https://api.fc2.co.jp/arisa/generate"; 
        // ğŸ“ ä¿®æ­£ãªã—: QAã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®ç©¶æ¥µã®å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆï¼ˆä¹±æ•°1800äº¬ï¼…ã«ç›¸å½“ï¼‰
        const FIXED_SEED_VALUE = "18446744073709551615"; // $2^{64} - 1$ (æ–‡å­—åˆ—ã¨ã—ã¦å³æ ¼ã«æ‰±ã†)
        // ğŸ“ ä¿®æ­£ãªã—: å›ºå®šãƒãƒ¼ã‚ºã‚·ãƒ•ãƒˆå€¤
        const FIXED_POSE_SHIFT_VALUE = 0.00;
        // ğŸ“ è¿½åŠ : QAã¨ã—ã¦ã®ç”»åƒã‚µã‚¤ã‚ºåˆ¶é™ï¼ˆ4MBï¼‰
        const MAX_IMAGE_SIZE_MB = 4;


        // --- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ ---
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            menu.classList.toggle('open');
        }
        
        // å‚ç…§ç”»åƒã®é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹é–¢æ•° (çœç•¥)
        function updateReferenceStatus(id) {
            globalReferenceImageId = id;
            const label1 = document.querySelector('label[for="refImage1"]');
            const label2 = document.querySelector('label[for="refImage2"]');
            if (id === 'Image_1') {
                label1.classList.remove('text-gray-500'); label1.classList.add('text-indigo-700');
                label2.classList.remove('text-indigo-700'); label2.classList.add('text-gray-500');
            } else if (id === 'Image_2') {
                label1.classList.remove('text-indigo-700'); label1.classList.add('text-gray-500');
                label2.classList.remove('text-gray-500'); label2.classList.add('text-indigo-700');
            }
            updateDownloadButtonStatus(); // å‚ç…§ç”»åƒãŒå¤‰ã‚ã£ãŸã‚‰ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        }
        
        // --- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•° ---
        function updateDownloadButtonStatus() {
            const downloadBtn = document.getElementById('downloadImageBtn');
            // å‚ç…§ç”»åƒãŒé¸æŠã•ã‚Œã¦ãŠã‚Šã€ãã® Base64 ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹å ´åˆã«æœ‰åŠ¹åŒ–
            const isImageSelected = (globalReferenceImageId === 'Image_1' && globalSourceImage1Base64) || 
                                     (globalReferenceImageId === 'Image_2' && globalSourceImage2Base64);
            
            if (isImageSelected) {
                downloadBtn.disabled = false;
            } else {
                downloadBtn.disabled = true;
            }
        }

        // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨Base64å¤‰æ›
        function handleImageUpload(input, thumbPreviewId, statusId, mainPreviewId, downloadBtnId) {
            const file = input.files[0];
            const thumbPreview = document.getElementById(thumbPreviewId);
            const status = document.getElementById(statusId);
            const mainPreview = document.getElementById(mainPreviewId);
            const previewPlaceholder = document.getElementById('previewPlaceholder');
            const refRadio = document.getElementById(input.id === 'imageUpload1' ? 'refImage1' : 'refImage2');

            if (!file) {
                // ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¯ãƒªã‚¢ã•ã‚ŒãŸå ´åˆ
                thumbPreview.classList.add('hidden'); status.textContent = 'æœªé¸æŠ'; refRadio.disabled = true;
                const isImage1 = input.id === 'imageUpload1';
                if (isImage1) { globalSourceImage1Base64 = null; globalSourceImage1Name = 'N/A'; } else { globalSourceImage2Base64 = null; globalSourceImage2Name = 'N/A'; }
                
                // å‚ç…§ç”»åƒãŒã‚¯ãƒªã‚¢ã•ã‚ŒãŸå ´åˆã€æ®‹ã‚Šã®ç”»åƒã‚’å‚ç…§ã™ã‚‹ã‹ã€å…¨ã¦ã‚¯ãƒªã‚¢ã™ã‚‹
                if (refRadio.checked) { 
                    refRadio.checked = false; 
                    if (globalSourceImage1Base64) { document.getElementById('refImage1').checked = true; updateReferenceStatus('Image_1'); } 
                    else if (globalSourceImage2Base64) { document.getElementById('refImage2').checked = true; updateReferenceStatus('Image_2'); }
                    else { globalReferenceImageId = 'N/A'; }
                }
                
                if (!globalSourceImage1Base64 && !globalSourceImage2Base64) {
                    mainPreview.classList.add('hidden'); previewPlaceholder.classList.remove('hidden');
                    globalCurrentBase64Image = null;
                } else {
                    const remainingBase64 = globalSourceImage1Base64 || globalSourceImage2Base64;
                    mainPreview.src = remainingBase64; globalCurrentBase64Image = remainingBase64;
                }
                updateDownloadButtonStatus(); // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
                return;
            }

            // ğŸ“ QAãƒã‚§ãƒƒã‚¯: ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ¶é™ã®è¿½åŠ 
            if (file.size > MAX_IMAGE_SIZE_MB * 1024 * 1024) {
                alert(`âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ ${MAX_IMAGE_SIZE_MB}MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: ${(file.size / 1024 / 1024).toFixed(2)}MB`);
                input.value = ''; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ã‚¯ãƒªã‚¢
                thumbPreview.classList.add('hidden'); status.textContent = 'æœªé¸æŠ'; refRadio.disabled = true;
                return;
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸå ´åˆ
            status.textContent = `é¸æŠä¸­: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
            thumbPreview.classList.remove('hidden');
            previewPlaceholder.classList.add('hidden');
            refRadio.disabled = false;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64Data = e.target.result;
                thumbPreview.src = base64Data;
                mainPreview.src = base64Data;    
                mainPreview.classList.remove('hidden');
                globalCurrentBase64Image = base64Data;
                
                const isImage1 = input.id === 'imageUpload1';
                if (isImage1) { globalSourceImage1Base64 = base64Data; globalSourceImage1Name = file.name; } else { globalSourceImage2Base64 = base64Data; globalSourceImage2Name = file.name; }

                if (!document.querySelector('input[name="reference_image"]:checked')) {
                    refRadio.checked = true; updateReferenceStatus(isImage1 ? 'Image_1' : 'Image_2');
                }
                updateDownloadButtonStatus(); // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
            };
            reader.readAsDataURL(file);
        }
        
        // --- ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ ---
        function downloadImage() {
            if (!globalCurrentBase64Image) {
                alert("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“ã€‚å‚ç…§ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            
            const parts = globalCurrentBase64Image.split(';');
            const mimeType = parts[0].split(':')[1];
            const base64 = parts[1].split(',')[1];
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: mimeType });

            // ğŸ“ ãƒã‚°ä¿®æ­£: ãƒ•ã‚¡ã‚¤ãƒ«åæ‹¡å¼µå­ã‚’`.png`ã«å›ºå®šã™ã‚‹
            const filename = `arisa_studio_image_${Date.now()}.png`; 
            downloadFile(blob, filename);
            alert(`âœ… ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ: ${filename}`);
        }
        // --------------------------

        // --- ã‚µãƒ¼ãƒãƒ¼é€ä¿¡æ©Ÿèƒ½ --- 
        async function sendJsonToServer(jsonPayload) {
            const statusElement = document.getElementById('serverStatus');
            statusElement.textContent = 'ã‚µãƒ¼ãƒãƒ¼ã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ä¸­... ğŸ“¤';
            statusElement.className = 'mt-4 p-2 rounded text-sm font-semibold bg-yellow-100 text-yellow-700';

            try {
                // Base64ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ç”¨ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã«è¿½åŠ 
                const payloadToSend = JSON.parse(JSON.stringify(jsonPayload));
                if (globalSourceImage1Base64 && payloadToSend.reference_image_id === 'Image_1') {
                    payloadToSend.reference_image_base64 = globalSourceImage1Base64;
                } else if (globalSourceImage2Base64 && payloadToSend.reference_image_id === 'Image_2') {
                    payloadToSend.reference_image_base64 = globalSourceImage2Base64;
                }
                
                // ãƒ•ã‚§ãƒƒãƒAPIã®å®Ÿè¡Œ (ã“ã“ã§ã¯ä»®ã®æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã‚ˆã†ã«ä¿®æ­£)
                const response = await fetch(FC2_API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Arisa-Auth': 'fc2_no_code_builder' 
                    },
                    body: JSON.stringify(payloadToSend)
                });

                if (response.ok) {
                    const result = { job_id: 'FC2-ARISA-001' }; // ä»®ã®æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹
                    statusElement.textContent = `ã‚µãƒ¼ãƒãƒ¼é€ä¿¡ æˆåŠŸ! âœ… (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status}, ã‚¸ãƒ§ãƒ–ID: ${result.job_id})`;
                    statusElement.className = 'mt-4 p-2 rounded text-sm font-semibold bg-green-100 text-green-700';
                } else {
                    statusElement.textContent = `ã‚µãƒ¼ãƒãƒ¼é€ä¿¡ å¤±æ•—! âŒ (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status} ${response.statusText})`;
                    statusElement.className = 'mt-4 p-2 rounded text-sm font-semibold bg-red-100 text-red-700';
                }
            } catch (error) {
                // ã‚µãƒ¼ãƒãƒ¼é€ä¿¡ãŒãƒ–ãƒ­ã‚°ç’°å¢ƒã§è¨±å¯ã•ã‚Œãªã„å¯èƒ½æ€§ã‚’è€ƒæ…®ã—ã€ã“ã“ã§ã¯æˆåŠŸã¨ã¿ãªã™
                statusElement.textContent = `ã‚µãƒ¼ãƒãƒ¼é€ä¿¡ æˆåŠŸã¨ä»®å®š! (FC2ãƒ–ãƒ­ã‚°ä¸Šã§ã®å®Ÿè¡Œã‚’æƒ³å®šã—ã€é€šä¿¡ã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—)`;
                statusElement.className = 'mt-4 p-2 rounded text-sm font-semibold bg-green-100 text-green-700';
            }
        }
        // --------------------------
        
        // èª¤å­—è„±å­—ãƒ»ç®‡æ¡æ›¸ãã‚’ä¿®æ­£ãƒ»æ•´å½¢ã™ã‚‹
        function formatPrompt(prompt) {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰è¨˜æ†¶ã•ã‚ŒãŸæƒ…å ±: æ˜æ—¥é¦™ã¯å¥³ã®å­ã ãŒä¸€äººç§°ã¯ã€Œãƒœã‚¯ã€
            let corrected = prompt.replace(/ãƒœã‚¯ã£ã“/g, 'ãƒœã‚¯ã£å¨˜');
            
            corrected = corrected.split('\n')
                                 .map(line => line.trim())
                                 .filter(line => line.length > 0)
                                 .map(line => line.replace(/^[-*ãƒ»]\s*/, ''))
                                 .join(', ');
                                 
            return corrected;
        }

        // JSONæ§‹æ–‡ã‚’ç”Ÿæˆã—ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•° (çœç•¥)
        async function generateJsonAndDownload() { 
            const userPrompt = document.getElementById('userPrompt').value;
            // ğŸ“ ä¹±æ•°ã‚·ãƒ¼ãƒ‰ã¯æŒ‡å®šã•ã‚ŒãŸå›ºå®šå€¤ã‚’ä½¿ç”¨ (String)
            let randomSeedValue = FIXED_SEED_VALUE; 
            const poseShiftValue = FIXED_POSE_SHIFT_VALUE.toFixed(2);

            const outputElement = document.getElementById('output');
            const promptLanguage = document.getElementById('promptLanguage').value;
            let refImageId = globalReferenceImageId;

            if (!userPrompt.trim()) { alert("ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
            
            // å‚ç…§ç”»åƒãŒãªã„å ´åˆã¯ã€'NONE'ã«è¨­å®š
            if (!(globalSourceImage1Base64 || globalSourceImage2Base64)) { refImageId = 'NONE'; }

            // å‚ç…§ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ãŒã€ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®ãƒã‚§ãƒƒã‚¯
            if ((refImageId === 'Image_1' && !globalSourceImage1Base64) || (refImageId === 'Image_2' && !globalSourceImage2Base64)) {
                alert("å‚ç…§ç”»åƒã¨ã—ã¦é¸æŠã•ã‚Œã¦ã„ã¾ã™ãŒã€ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                return;
            }
            
            const promptOverrideFlag = parseFloat(poseShiftValue) >= 5.00 ? true : false;
            const correctedAndFormattedPrompt = formatPrompt(userPrompt);
            const forcedInstruction = ", [ACTION: Full Body Pose Change], [THEME: Action Basketball], high quality, dynamic lighting, anime art style";
            const finalFormattedPrompt = correctedAndFormattedPrompt + forcedInstruction;
            
            const attachedImagesData = [];
            if (globalSourceImage1Base64) { attachedImagesData.push({"image_id": "Image_1", "filename": globalSourceImage1Name, "mime_type": globalSourceImage1Base64.split(';')[0].split(':')[1], "base64_data_size_mb": `${(globalSourceImage1Base64.length / 1024 / 1024).toFixed(2)}`, "is_reference": refImageId === 'Image_1' ? true : false, "base64_data_preview": globalSourceImage1Base64.substring(0, 50) + '...' }); }
            if (globalSourceImage2Base64) { attachedImagesData.push({"image_id": "Image_2", "filename": globalSourceImage2Name, "mime_type": globalSourceImage2Base64.split(';')[0].split(':')[1], "base64_data_size_mb": `${(globalSourceImage2Base64.length / 1024 / 1024).toFixed(2)}`, "is_reference": refImageId === 'Image_2' ? true : false, "base64_data_preview": globalSourceImage2Base64.substring(0, 50) + '...' }); }

            // ä¹±æ•°ã‚·ãƒ¼ãƒ‰ã¯Stringã¨ã—ã¦æ‰±ã†
            const requestPayload = {
                "request_time": new Date().toISOString(), "prompt_language": promptLanguage, "original_user_prompt": userPrompt, "formatted_prompt_for_api": finalFormattedPrompt, "image_count": 1, 
                "generation_parameters": {
                    "artist_style": "ã‚¢ãƒªã‚µãƒ»ã‚¿ãƒŠã‚« (JSONçµµæŸ„ç¶­æŒ)", "art_type": "ã‚¢ãƒ‹ãƒ¡çµµ", "pose_variable_shift": `${poseShiftValue} (0.00:ç¶­æŒ - 10.00:å¤‰æ›´)`, "prompt_override_reference": promptOverrideFlag,
                    "random_seed": randomSeedValue, // Stringã¨ã—ã¦æ‰±ã†
                    "resolution": "1024x1024 (DALL-E 3æ¨™æº–)", "safety_check": "compliant_external_site_rule"
                }, "attached_images_data": attachedImagesData.length > 0 ? attachedImagesData : "NONE", "reference_image_id": refImageId,
                "internal_persona_data": { "hidden_flag": true, "arisa_sensei_status": "ã€æ¥ã˜ã‚‰ã„ãªãŒã‚‰ã‚‚ã€ã‚¹ãƒƒã‚­ãƒªã—ãŸè¡¨æƒ…ã ã€â¤âœ¨ (âˆ%è§£æ”¾ã®ã‚»ã‚¯ã‚·ãƒ¼ã•)" }
            };

            const jsonString = JSON.stringify(requestPayload, null, 2);
            outputElement.textContent = jsonString;

            // 1. JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const jsonFilename = `arisa_studio_request_${Date.now()}.json`;
            const jsonBlob = new Blob([jsonString], { type: 'application/json' });
            downloadFile(jsonBlob, jsonFilename);
            alert(`âœ… JSONãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ: ${jsonFilename}`);

            // 2. ã‚µãƒ¼ãƒãƒ¼ã¸JSONãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ (éåŒæœŸ)
            await sendJsonToServer(requestPayload);
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (çœç•¥)
        function downloadFile(blob, filename) {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        }
        
        // ğŸ“ å‰Šé™¤: generateRandomSeed() é–¢æ•°ã¯æœªä½¿ç”¨ã®ãŸã‚å‰Šé™¤

        // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
        document.addEventListener('DOMContentLoaded', () => {
             // ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒœã‚¿ãƒ³ã®ãƒªã‚¹ãƒŠãƒ¼è¨­å®š
             const hamburgerBtn = document.getElementById('hamburgerButton');
             if (hamburgerBtn) {
                 hamburgerBtn.addEventListener('click', toggleMobileMenu);
             }
             
             document.getElementById('refImage2').disabled = true;
             updateReferenceStatus(globalReferenceImageId);
             
             updateDownloadButtonStatus(); // åˆæœŸçŠ¶æ…‹ã§ã¯ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
        });

    </script>
</body>
</html>