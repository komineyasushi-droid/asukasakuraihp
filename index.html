<script>
// =======================================================
// JSONデータとカレンダー表示のロジック
// =======================================================

let diaryData = []; 
let diaryMap = new Map(); 
let currentDate = new Date(); 

// 💡 未来の月変更を制限する限界日を設定 (現在から約5年後)
const maxFutureDate = new Date();
maxFutureDate.setFullYear(maxFutureDate.getFullYear() + 5);

fetch("diary.json") 
    .then(response => {
        if (!response.ok) {
            throw new Error('JSONファイルを読み込めませんでした。ステータス: ' + response.status);
        }
        return response.json(); 
    })
    .then(data => {
        diaryData = data;
        diaryData.forEach(entry => {
            diaryMap.set(entry.date, entry);
        });

        if (diaryData.length > 0) {
            displayDiaryEntry(diaryData[0].date);
        } else {
            document.getElementById("news-area").innerHTML = `<article class="entry"><h2>日記データがありません。</h2><div class="content">日記ファイル(diary.json)にデータが記述されていません。</div></article>`;
        }

        renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
    })
    .catch(err => {
        const area = document.getElementById("news-area");
        area.innerHTML = `<p style="color: red; font-weight: bold;">日記データファイルを読み込めませんでした。GitHub上のファイル名(diary.json)とJSON形式を確認してください。</p>`;
        console.error("JSONデータの読み込みまたは解析に失敗:", err);
    });

function displayDiaryEntry(date) { 
    const entry = diaryMap.get(date);
    const area = document.getElementById("news-area");
    // 💡 日記タイトルを更新
    document.querySelector('.main h1').textContent = `${date}の明日香の日記`; 

    if (entry) {
        area.innerHTML = `<article class="entry"><h2>${entry.title}</h2><div class="content">${entry.body || "本文なし"}</div></article>`;
    } else {
        area.innerHTML = `<article class="entry"><h2>${date} の日記</h2><div class="content">この日の日記はまだありません。</div></article>`;
    }
    updateSelectedDay(date);
}

function renderCalendar(year, month) {
    const calendarArea = document.getElementById('calendar-area');
    const firstDayOfMonth = new Date(year, month, 1).getDay(); 
    const daysInMonth = new Date(year, month + 1, 0).getDate(); 
    const today = new Date();
    const currentDayKey = formatDate(today);
    
    // 💡 月を進めるボタンの表示判定
    const nextMonth = new Date(year, month + 1, 1);
    let nextButton = `<button onclick="changeMonth(1)">&#9654;</button>`;
    if (nextMonth > maxFutureDate) {
        nextButton = `<button style="opacity: 0.3; cursor: default;">&#9654;</button>`;
    }

    let html = '';
    
    html += '<div class="calendar-header">';
    html += `<button onclick="changeMonth(-1)">&#9664;</button>`; 
    html += `<span>${year}年 ${month + 1}月</span>`;
    html += nextButton;
    html += '</div>';

    html += '<table class="calendar-table">';
    html += '<thead><tr><th>日</th><th>月</th><th>火</th><th>水</th><th>木</th><th>金</th><th>土</th></tr></thead>';
    html += '<tbody><tr>';

    let day = 1;
    let i; 

    for (i = 0; i < firstDayOfMonth; i++) {
        html += '<td></td>';
    }

    for (; i < 7; i++) {
        if (day <= daysInMonth) {
            html += createDayCell(year, month, day++, currentDayKey);
        } else {
            html += '<td></td>';
        }
    }
    html += '</tr>';

    while (day <= daysInMonth) {
        html += '<tr>';
        for (i = 0; i < 7 && day <= daysInMonth; i++) {
            html += createDayCell(year, month, day++, currentDayKey);
        }
        if (day > daysInMonth) {
            for (; i < 7; i++) {
                html += '<td></td>';
            }
        }
        html += '</tr>';
    }
    
    html += '</tbody></table>';
    
    const wrapper = document.createElement('div');
    wrapper.innerHTML = html;
    calendarArea.innerHTML = '';
    calendarArea.appendChild(wrapper);

    if (diaryData.length > 0) {
        updateSelectedDay(diaryData[0].date);
    }
}
function createDayCell(year, month, day, currentDayKey) {
    const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    let className = '';
    if (dateKey === currentDayKey) { className += ' today'; }
    if (diaryMap.has(dateKey)) { className += ' has-diary'; }
    // 💡 onclickで日記表示関数を呼ぶことで「実用リンク」として機能しています。
    return `<td class="${className}" data-date="${dateKey}" onclick="handleDayClick('${dateKey}')">${day}</td>`;
}

function changeMonth(delta) { 
    const nextDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + delta, 1);
    
    // 💡 5年先の月を超えないように制限
    if (delta > 0 && nextDate > maxFutureDate) {
        return; 
    }
    
    currentDate.setMonth(currentDate.getMonth() + delta); 
    renderCalendar(currentDate.getFullYear(), currentDate.getMonth()); 
}
function handleDayClick(dateKey) { 
    displayDiaryEntry(dateKey); 
}
function updateSelectedDay(dateKey) {
    document.querySelectorAll('.calendar-table td').forEach(td => { td.classList.remove('selected-day'); });
    const selectedTd = document.querySelector(`td[data-date="${dateKey}"]`);
    if (selectedTd) { selectedTd.classList.add('selected-day'); }
}
function formatDate(date) {
    const yyyy = date.getFullYear();
    const mm = String(date.getMonth() + 1).padStart(2, '0');
    const dd = String(date.getDate()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd}`;
}

</script>